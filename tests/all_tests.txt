===== conftest.py =====
import os
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from fastapi.testclient import TestClient

from app.core.database import Base, get_db
from app.main import app  # ğŸ‘ˆ Ø´ÛŒØ¡ FastAPI Ø¯Ø±Ø³Øª

# Ù‡Ù…Ù‡ Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ú©Ù† ØªØ§ Ø¯Ø± metadata Ø«Ø¨Øª Ø´ÙˆÙ†Ø¯
import app.models.user
import app.models.tenant
import app.models.refresh_token


# Ù…Ø³ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ³Øª
TEST_DB_URL = "sqlite:///./test.db"


@pytest.fixture(scope="session")
def engine():
    # Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØªØ³Øª ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ù¾Ø§Ú©Ø´ Ú©Ù†
    if os.path.exists("test.db"):
        os.remove("test.db")
    return create_engine(TEST_DB_URL, connect_args={"check_same_thread": False})


@pytest.fixture(scope="session")
def TestingSessionLocal(engine):
    return sessionmaker(bind=engine, autocommit=False, autoflush=False)


@pytest.fixture(autouse=True)
def setup_database(engine, TestingSessionLocal):
    # Ø³Ø§Ø®Øª Ø¬Ø¯Ø§ÙˆÙ„
    Base.metadata.drop_all(bind=engine)
    Base.metadata.create_all(bind=engine)

    def override_get_db():
        db = TestingSessionLocal()
        try:
            yield db
        finally:
            db.close()

    # ğŸ‘ˆ override Ú©Ø±Ø¯Ù† dependency Ø±ÙˆÛŒ Ø´ÛŒØ¡ FastAPI
    app.dependency_overrides[get_db] = override_get_db

    yield

    # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± ØªØ³Øª
    Base.metadata.drop_all(bind=engine)


@pytest.fixture
def client():
    return TestClient(app)


===== test_users_me.py =====
# tests/test_users_me.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)


def test_me_authenticated():
    email = "meuser@example.com"
    password = "meuserpass123"

    # register
    r = client.post("/auth/register", json={"email": email, "password": password})
    assert r.status_code == 201

    # login (get tokens)
    login = client.post(
        "/auth/login",
        data={"username": email, "password": password},
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    assert login.status_code == 200
    tokens = login.json()
    access_token = tokens["access_token"]

    # /users/me with Authorization header
    me = client.get("/users/me", headers={"Authorization": f"Bearer {access_token}"})
    assert me.status_code == 200
    body = me.json()
    assert body["email"] == email
    assert "id" in body


def test_me_unauthenticated():
    me = client.get("/users/me")
    assert me.status_code == 401
    assert me.json()["detail"] in (
        "Not authenticated",
        "Could not validate credentials",
    )


===== test_refresh_flow.py =====
# app/api/v1/tests/test_refresh_flow.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)


def test_refresh_flow_success_and_rotation():
    email = "flow@example.com"
    password = "pass123456"

    # register
    r = client.post("/auth/register", json={"email": email, "password": password})
    assert r.status_code == 201

    # login (get initial tokens)
    login = client.post(
        "/auth/login",
        data={"username": email, "password": password},
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    assert login.status_code == 200
    body = login.json()
    assert "access_token" in body and "refresh_token" in body
    refresh_token = body["refresh_token"]

    # refresh (JSON)
    refresh = client.post("/auth/refresh", json={"refresh_token": refresh_token})
    assert refresh.status_code == 200
    refreshed = refresh.json()
    assert "access_token" in refreshed
    assert "refresh_token" in refreshed
    new_refresh = refreshed["refresh_token"]

    # old refresh must now be invalid (revoked)
    refresh_again = client.post("/auth/refresh", json={"refresh_token": refresh_token})
    assert refresh_again.status_code == 401
    assert refresh_again.json()["detail"] == "Invalid or expired refresh token"

    # new refresh must be valid
    refresh_new = client.post("/auth/refresh", json={"refresh_token": new_refresh})
    assert refresh_new.status_code == 200
    refreshed_2 = refresh_new.json()
    assert "access_token" in refreshed_2
    assert "refresh_token" in refreshed_2


def test_refresh_invalid_token():
    resp = client.post("/auth/refresh", json={"refresh_token": "non-existent-token"})
    assert resp.status_code == 401
    assert resp.json()["detail"] == "Invalid or expired refresh token"


===== test_auth_flow.py =====
# tests/test_auth_flow.py (Ø¬Ø¯ÛŒØ¯)
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)


def test_login_json_payload():
    email = "jsonlogin@example.com"
    password = "strongjsonpass"

    client.post("/auth/register", json={"email": email, "password": password})

    # login via JSON
    resp = client.post("/auth/login", json={"email": email, "password": password})
    assert resp.status_code == 200
    data = resp.json()
    assert "access_token" in data
    assert "refresh_token" in data


===== test_auth_failures.py =====
from jose import jwt
from app.core.config import settings


def test_me_without_token(client):
    """
    1ï¸âƒ£ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ route Ù…Ø­Ø§ÙØ¸Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù†
    Ø§Ù†ØªØ¸Ø§Ø±: 401 Unauthorized
    """
    response = client.get("/users/me")
    assert response.status_code == 401


def test_me_with_invalid_token(client):
    """
    2ï¸âƒ£ Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø®Ø±Ø§Ø¨ / Ù†Ø§Ù…Ø¹ØªØ¨Ø±
    Ø§Ù†ØªØ¸Ø§Ø±: 401 Unauthorized
    """
    response = client.get(
        "/users/me",
        headers={"Authorization": "Bearer invalid.token.value"},
    )
    assert response.status_code == 401


def test_me_user_not_found(client):
    """
    3ï¸âƒ£ ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± ÙˆÙ„ÛŒ user Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ sub ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
    (Ù…Ø«Ù„Ø§Ù‹ user_id = 999)
    Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù…Ø§: 401 Unauthorized
    """

    token = jwt.encode(
        {"sub": "999"},
        settings.secret_key,
        algorithm=settings.algorithm,
    )

    response = client.get(
        "/users/me",
        headers={"Authorization": f"Bearer {token}"},
    )

    assert response.status_code == 401


===== test_auth_basic.py =====
# app/api/v1/tests/test_auth_basic.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)


def test_register_success():
    response = client.post(
        "/auth/register",
        json={
            "email": "user1@example.com",
            "password": "strongpassword123",
        },
    )
    assert response.status_code == 201
    data = response.json()
    assert "id" in data
    assert data["email"] == "user1@example.com"
    assert "password" not in data
    assert "hashed_password" not in data


def test_register_duplicate_email():
    payload = {
        "email": "duplicate@example.com",
        "password": "password123",
    }
    r1 = client.post("/auth/register", json=payload)
    assert r1.status_code == 201

    r2 = client.post("/auth/register", json=payload)
    assert r2.status_code == 400
    body = r2.json()
    assert body["detail"] == "Email already registered"


def test_login_success_oauth2_form():
    email = "login_form@example.com"
    password = "password123"

    # register
    r = client.post("/auth/register", json={"email": email, "password": password})
    assert r.status_code == 201

    # login via OAuth2 form
    response = client.post(
        "/auth/login",
        data={"username": email, "password": password},
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert "refresh_token" in data
    assert data["token_type"] == "bearer"


def test_login_success_json_body():
    email = "login_json@example.com"
    password = "password123"

    # register
    r = client.post("/auth/register", json={"email": email, "password": password})
    assert r.status_code == 201

    # login via JSON body
    response = client.post("/auth/login", json={"email": email, "password": password})
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert "refresh_token" in data
    assert data["token_type"] == "bearer"


def test_login_invalid_credentials():
    response = client.post(
        "/auth/login",
        data={"username": "notfound@example.com", "password": "wrongpassword"},
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    assert response.status_code == 401
    body = response.json()
    assert body["detail"] == "Invalid credentials"


